# Substate - Record/Replay Transactions Efficiently

Ethereum substate recorder/replayer based on the paper:

**Yeonsoo Kim, Seongho Jeong, Kamil Jezek, Bernd Burgstaller, and Bernhard Scholz**: _An Off-The-Chain Execution Environment for Scalable Testing and Profiling of Smart Contracts_,  USENIX ATC'21

To build all programs, simply run `make all`.

## Record transaction substates
Use `geth import` to save transaction substates in the argument of `--substatedir`
(default: `substate.ethereum`).

There are 5 data structures stored in substate DB:
1. `SubstateAccount`: account information (nonce, balance, code, storage)
2. `SubstateAlloc`: mapping of account address and `SubstateAccount`
3. `SubstateEnv`: information from block headers (block gasLimit, number, timestamp, hashes)
4. `SubstateMessage`: message for transaction execution
5. `SubstateResult`: result of transaction execution

5 values are required to replay transactions and validate results:
1. `InputAlloc`: alloc that read during transaction execution
2. `Env`: block information required for transaction execution
3. `Message`: array with exactly 1 transaction
4. `OutputAlloc`: alloc that generated by transaction execution
5. `Result`: execution result and receipt array with exactly 1 receipt

The First 2 bytes of a key in substate DB represent different data types as follows:
1. `1s`: Substate, a key is `"1s"+N+T` with transaction index `T` at block `N`.
`T` and `N` are encoded in a big-endian 64-bit binary.
2. `1c`: EVM bytecode, a key is `"1c"+codeHash` where `codeHash` is Keccak256 hash of the bytecode.

## Replay trasnactions

`substate-cli replay` receives a range of blocks,
loads substates of transactions within the range from `substate.ethereum`,
execute them and check whether execution results are correct.
If `substate-cli replay` finds an execution result that is not equivalent to the recorded one,
it returns an error immediately.

For example, if you want to replay transactions from 46147 to 50000:
```bash
# replay transactions and check whether execution results are correct
./substate-cli replay 46147 50000
```

Here are command line options for `substate-cli replay`:
```
replay [command options] <blockNumFirst> <blockNumLast>

The substate-cli replay command requires two arguments:
<blockNumFirst> <blockNumLast>

<blockNumFirst> and <blockNumLast> are the first and
last block of the inclusive range of blocks to replay transactions.

OPTIONS:
   --workers value      Number of worker threads that execute in parallel (default: 4)
   --skip-transfer-txs  Skip executing transactions that only transfer ETH
   --skip-call-txs      Skip executing CALL transactions to accounts with contract bytecode
   --skip-create-txs    Skip executing CREATE transactions
   --substatedir value  Data directory for substate recorder/replayer (default: "substate.ethereum")
```

For example, if you want 8 workers to replay transactions except CREATE transactions:
```bash
# 8 workers will replay transactions that invoke bytecode execution
./substate-cli replay 46147 50000 --workers 8 --skip-create-txs
```

If you want to replay only CREATE transactions:
```bash
# 8 workers will replay transactions that invoke bytecode execution
./substate-cli replay 46147 50000 --skip-transfer-txs --skip-call-txs
```

### Hard-fork assessment
To assess hard-forks with old transactions, use `replay-fork` command with `--hard-fork` option. Run `./substate-cli replay-fork --help` for more details.

## Substate DB manipulation

`substate-cli db` is an additional CLI to manipulate substate DB directly.
To build `substate-cli` simply run `make all`.

### `upgrade`
`substate-cli db upgrade` command convert old DB layout (`stage1-substate`) used for the USENIX ATC'21 paper to new DB layout (`substate.ethereum`).
```
./substate-cli db upgrade stage1-substate substate.ethereum
```

### `clone`
`substate-cli db clone` command reads substates of a given block range and copies them in a substate DB clone.
```
./substate-cli db clone srcdb dstdb 46147 50000
```

### `compact`
`substate-cli db compact` command compacts any LevelDB instance including the substate DB.
```
./substate-cli db compact substate.ethereum
```
